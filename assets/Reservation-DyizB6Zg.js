import{r as n,u as ae,a as u,j as s}from"./index-dyTbaItY.js";import{u as le,a as oe}from"./useAvailableDesigners-DwcVJ3A7.js";function fe(){const[l,ce]=n.useState(()=>{const e=localStorage.getItem("token");return e?JSON.parse(atob(e.split(".")[1])):null}),[m,R]=n.useState([]),[c,T]=n.useState([]),[h,Q]=n.useState(null),[i,U]=n.useState(""),[a,b]=n.useState(""),[S,d]=n.useState(""),[q,$]=n.useState(!1),[v,P]=n.useState(null),[O,p]=n.useState(!1),[J,y]=n.useState(!1),[V,F]=n.useState([]),[f,G]=n.useState(null),[de,H]=n.useState(new Date),[ue,me]=n.useState(!0),[K,x]=n.useState(!1),X=ae(),[I,z]=n.useState([]),N=new Date().toISOString().slice(0,10),B=l?I.filter(e=>e.createdAt.slice(0,10)===N&&e.status!=="done"):[];n.useEffect(()=>{E(),Y(),Z(),_();const e=()=>{console.log("Reservation: 收到設計師狀態變更事件，重新載入設計師資料"),E()};return window.addEventListener("designer-state-changed",e),()=>{window.removeEventListener("designer-state-changed",e)}},[]),n.useEffect(()=>{if(!l)return;const e=async()=>{try{const r=await u.get(`/api/queue/user/${l.id}?date=${N}`);z(r.data)}catch{z([])}};e();const t=()=>{e()};return window.addEventListener("queue-updated",t),()=>{window.removeEventListener("queue-updated",t)}},[l,N]);const E=async()=>{try{const e=await u.get("/api/designers");R(e.data)}catch(e){console.error("載入設計師失敗:",e)}},Y=async()=>{try{const e=await u.get("/api/services");T(e.data)}catch(e){console.error("載入服務失敗:",e)}},Z=async()=>{try{const e=await u.get("/api/worktime");Q(e.data)}catch(e){console.error("載入工作時間失敗:",e)}},_=async()=>{try{const e=await u.get("/api/queue/today-stats");F(e.data.currentServing||[]),G(e.data.designerStats||null),H(new Date)}catch(e){console.error("載入當前服務狀態失敗:",e)}},ee=()=>{if(!h)return!0;const t=new Date().getDay();return h.openDays?.[t]||!1},j=le(m),o=oe(c,m,i),se=async()=>{if(!l){d("請先登入會員");return}if(i===""){d("請選擇設計師");return}if(!a){d("請選擇服務項目");return}if(console.log({designerId:i,serviceId:a,userId:l?.id}),!ee()){d("非常抱歉!  今日非營業日無法提供抽號服務 !!"),x(!0);return}$(!0),d("");try{const e=await u.post("/api/queue",{designerId:Number(i),serviceId:Number(a),userId:l.id,type:"online"});P(e.data.data)}catch(e){d(e.response?.data?.error||"抽號失敗"),x(!0)}finally{$(!1)}},te=()=>{X("/login?redirect=reservation")},M=e=>{U(Number(e)),p(!1)},ne=e=>{b(Number(e)),y(!1)},W=()=>{if(i===0)return"不指定";const e=m.find(t=>t.id===Number(i));return e?e.name:""},A=()=>{const e=c.find(t=>String(t.id)===String(a));return e?`${e.name} - $${e.price}`:""},ie=()=>{const e=new Date,t=["週日","週一","週二","週三","週四","週五","週六"];return`${e.getMonth()+1}/${e.getDate()} (${t[e.getDay()]})`},L=()=>{if(!h)return null;const t=new Date().getDay();if(!h.openDays?.[t])return s.jsx("div",{className:"business-status-message",children:s.jsx("p",{children:"⚠️ 今日非營業日"})});const r=h.openTimes?.[t];return r?.start&&r?.end?s.jsx("div",{className:"business-status-message",children:s.jsxs("p",{children:["✅ 營業中 - 今日營業時間：",r.start," - ",r.end]})}):null};return L(),n.useEffect(()=>{a&&!o.some(e=>String(e.id)===String(a))&&b("")},[i,c]),n.useEffect(()=>{o&&a&&!o.some(e=>String(e.id)===String(a))&&b("")},[o,a]),v?s.jsxs("div",{id:"reservation",className:"reservation-container",children:[s.jsxs("div",{className:"reservation-header",children:[s.jsx("h2",{style:{fontSize:"1.5rem",margin:"0 0 0.5em 0",fontWeight:700},children:"線上抽號"}),s.jsx("p",{children:"抽號成功！"})]}),s.jsxs("div",{className:"reservation-step",children:[s.jsx("h3",{children:"抽號成功！"}),s.jsxs("div",{style:{textAlign:"center",padding:"2em 0"},children:[s.jsx("h2",{style:{fontWeight:900,color:"#f7ab5e",marginBottom:"1em"},children:"您已成功抽到號碼"}),s.jsxs("div",{style:{fontSize:"2.2em",fontWeight:900,color:"#ff9800",marginBottom:"0.7em"},children:["號碼：",v.number]}),s.jsxs("div",{style:{fontSize:"1.2em",color:"#fff",marginBottom:"0.5em"},children:["設計師：",W()||v.designerName||"—"]}),s.jsxs("div",{style:{fontSize:"1.2em",color:"#fff",marginBottom:"0.5em"},children:["服務項目：",A()||v.serviceName||"—"]}),s.jsxs("div",{style:{fontSize:"1.1em",color:"#fff",marginBottom:"0.5em"},children:["抽號日期：",ie()]}),s.jsx("p",{style:{fontSize:"1.1em",color:"#f7ab5e",margin:"1.2em 0 1.5em 0"},children:"請留意叫號，或返回查看「即時看板」。"}),s.jsx("div",{style:{marginTop:"1rem",display:"flex",gap:"1rem",justifyContent:"center",width:"100%"},children:s.jsx("button",{className:"btn btn-secondary",onClick:()=>window.location.reload(),style:{textAlign:"center",width:"fit-content",marginLeft:"auto",marginRight:"auto",display:"block"},children:"返回"})})]})]})]}):s.jsxs("div",{id:"reservation",className:"reservation-container",children:[s.jsx("div",{className:"reservation-header",children:s.jsx("h2",{style:{fontSize:"1.5rem",margin:"0 0 0.5em 0",fontWeight:700},children:"線上抽號(僅限當日抽號)"})}),l&&B.length>0&&s.jsxs("div",{className:"user-queue-list new-user-queue-list",style:{marginBottom:"1em"},children:[s.jsx("div",{className:"user-queue-title",children:"您今日抽到的號碼："}),s.jsx("div",{className:"user-queue-btns",style:{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:"0.2em",justifyItems:"center"},children:B.map(e=>s.jsx("button",{className:"user-queue-btn new-user-queue-btn",style:{borderRadius:"50%",width:"2.5em",height:"2.5em",fontSize:"1.1em",border:"2px solid #f7ab5e",background:"#fff",color:"#f7ab5e",fontWeight:700,overflow:"hidden"},disabled:!0,children:s.jsx("span",{className:"user-queue-number",children:e.number})},e.id))})]}),l&&I.length===0&&s.jsxs("div",{style:{marginBottom:"1em",padding:"1rem",background:"rgba(33, 150, 243, 0.07)",borderRadius:"12px",border:"2px solid #ffc107",textAlign:"center"},children:[s.jsx("div",{style:{color:"#f7ab5e",fontWeight:500},children:"您今日還沒有抽號"}),s.jsx("div",{style:{color:"#f7ab5e",fontSize:"0.9rem",marginTop:"0.5rem"},children:"請前往現場排隊或線上預約抽號"})]}),s.jsxs("div",{className:"kanban-board",children:[L(),s.jsx("h3",{style:{margin:"0.2em 0 0.5em 0",fontWeight:"bold",fontSize:"1.1em"},children:"即時看板"}),s.jsx("div",{className:"kanban-list",children:m.map((e,t)=>{if(e.isOnVacation)return null;const r=V.find(g=>g.designerId===e.id);r&&c.find(g=>String(g.id)===String(r.serviceId));let w=null;if(f&&e){const g=f[e.id]?.waiting||0,k=(e.services||[]).map(D=>c.find(C=>C.id===D)?.duration||60),re=k.length?k.reduce((D,C)=>D+C,0)/k.length:60;w=(g+1)*re}return s.jsxs("div",{className:"kanban-card",children:[s.jsx("div",{className:"kanban-designer",children:e.name}),s.jsx("div",{className:"kanban-number",children:r?`${r.number} 號`:"暫無"}),s.jsxs("div",{className:"kanban-wait",children:["預估等待：",e.isPaused?"暫停服務":r||f&&f[e.id]?.waiting>0?r&&w!==null?`${Math.round(w)} 分鐘`:"—":"立刻"]})]},`kanban-${e.id}`)})})]}),s.jsxs("div",{className:"queue-col queue-col-right",children:[s.jsxs("div",{className:"queue-step",children:[s.jsx("h3",{children:"步驟 1：會員登入"}),s.jsx("div",{className:"member-selection",children:l?s.jsx("button",{className:"btn btn-primary member-logged-in",disabled:!0,children:"已登入會員"}):s.jsx("button",{className:"btn btn-primary",onClick:te,children:"註冊/登入會員"})})]}),s.jsxs("div",{className:"queue-step",children:[s.jsx("h3",{children:"步驟 2：選擇設計師"}),s.jsxs("div",{className:"designer-selection",children:[s.jsx("button",{className:`btn btn-secondary${i!==""?" selected":""}`,onClick:()=>p(!0),children:i!==""?W():"請選擇設計師"}),j.length===0&&s.jsx("p",{className:"no-available-designers",children:"⚠️ 目前沒有可用的設計師（可能為非營業日或所有設計師暫停接單）"})]})]}),s.jsxs("div",{className:"queue-step",children:[s.jsx("h3",{children:"步驟 3：選擇服務項目"}),s.jsxs("div",{className:"service-selection",children:[s.jsx("button",{className:`btn btn-secondary${a?" selected":""}`,onClick:()=>y(!0),disabled:i==="",children:a?A():i!==""?"請選擇服務項目":"請先選擇設計師"}),i===""&&s.jsx("p",{className:"service-hint",children:"⚠️ 請先選擇設計師，才能選擇對應的服務項目"})]})]}),s.jsx("div",{className:"queue-step",children:s.jsx("button",{className:"btn btn-primary",onClick:se,disabled:q||i===""||!a||j.length===0,children:q?"處理中...":"確認抽號"})})]}),O&&s.jsx("div",{className:"modal-overlay",onClick:()=>p(!1),children:s.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[s.jsx("h3",{children:"選擇設計師"}),s.jsxs("div",{className:"designer-grid",children:[s.jsx("button",{className:`designer-item${i===0?" selected":""}`,onClick:()=>M(0),children:"不指定"},0),j.map(e=>s.jsx("button",{className:`designer-item${i===e.id?" selected":""}`,onClick:()=>M(e.id),children:e.name},e.id))]}),j.length===0&&s.jsx("p",{children:"目前沒有可用的設計師"})]})}),J&&(()=>{const e=m.find(t=>t.id===Number(i));return console.log("designer.services:",e?.services),console.log("services:",c),console.log("getAvailableServices:",o),s.jsx("div",{className:"modal-overlay",onClick:()=>y(!1),children:s.jsxs("div",{className:"modal-content service-modal",onClick:t=>t.stopPropagation(),children:[s.jsx("h3",{children:"選擇服務項目"}),s.jsx("div",{className:"service-grid",children:o.map(t=>s.jsxs("button",{className:`service-item${a===String(t.id)?" selected":""}`,onClick:()=>ne(t.id),children:[s.jsx("div",{children:t.name}),s.jsxs("div",{children:["$",t.price]})]},t.id))}),o.length===0&&s.jsx("p",{children:"此設計師暫無可選服務"})]})})})(),K&&s.jsx("div",{className:"modal-overlay",onClick:()=>x(!1),children:s.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),style:{maxWidth:"350px",textAlign:"center"},children:[s.jsx("h3",{style:{marginBottom:"1em"},children:"抽號失敗"}),s.jsx("div",{style:{textAlign:"center",marginBottom:"0.5em"},children:s.jsx("span",{style:{fontSize:"2.5em",color:"#d32f2f"},children:"❌"})}),S&&S!=="抽號失敗"&&s.jsx("div",{style:{marginBottom:"1em",fontSize:"1.3em",color:"#d32f2f",fontWeight:"bold"},children:S}),s.jsx("button",{className:"btn btn-primary",onClick:()=>x(!1),children:"關閉"})]})})]})}export{fe as default};
