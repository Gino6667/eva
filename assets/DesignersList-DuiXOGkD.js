import{r as i,a as c,j as t}from"./index-CMs8uBbc.js";function ae(){const[S,P]=i.useState([]),[z,g]=i.useState([]),[D,R]=i.useState([]),[I,A]=i.useState(!1),[se,E]=i.useState(null),[O,J]=i.useState([]),[o,f]=i.useState(null),[l,x]=i.useState(""),[$,h]=i.useState(""),[b,B]=i.useState(!1),[H,u]=i.useState(""),M=new Date().toISOString().slice(0,10),[N,q]=i.useState(""),[C,k]=i.useState(!1),[y,F]=i.useState(null),[V,U]=i.useState([]),[ie,G]=i.useState(""),[v,W]=i.useState(null);i.useEffect(()=>{d();const e=setInterval(d,6e4),n=()=>{console.log("收到設計師狀態變更事件，重新載入資料"),d()},s=()=>{console.log("收到排隊狀態變更事件，重新載入資料"),d()};return window.addEventListener("designer-state-changed",n),window.addEventListener("queue-updated",s),()=>{clearInterval(e),window.removeEventListener("designer-state-changed",n),window.removeEventListener("queue-updated",s)}},[d]);const d=async()=>{try{const[e,n,s]=await Promise.all([c.get("/api/designers"),c.get("/api/queue/today-stats"),c.get("/api/queue/next-in-queue")]);P(e.data),g(n.data.currentServing||[]),R(s.data||[]),p()}catch{P([{id:1,name:"小美",isPaused:!1,isOnVacation:!1},{id:2,name:"阿強",isPaused:!1,isOnVacation:!1},{id:3,name:"小華",isPaused:!1,isOnVacation:!1}]),g([]),R([])}},p=async()=>{try{const e=new Date().toISOString().slice(0,10),r=(await(await fetch(`/api/queue?date=${e}`)).json()).filter(a=>a.status==="waiting"||a.status==="called");J(r)}catch(e){console.error("載入今日排隊失敗:",e)}},K=e=>{const n=z.find(r=>r.designerId===e.id&&r.status!=="absent"),s=D.find(r=>r.designerId===e.id);return{currentNumber:n?.number??"-",currentService:n?.serviceName??"-",nextNumber:s?.number??"-",nextService:s?.serviceName??"-",status:n?"serving":"rest"}},X=e=>{E(e),A(!0),p()},Y=async()=>{if(!o||!l){u("請選擇客人和目標設計師");return}if(o.designerId===Number(l)){u("無法調整給同一位設計師");return}try{B(!0);const e=await fetch("/api/queue/transfer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queueId:o.id,fromDesignerId:o.designerId,toDesignerId:Number(l),reason:$||"設計師調整"})});if(e.ok)u("客人調整成功！"),f(null),x(""),h(""),d(),p(),window.dispatchEvent(new CustomEvent("designer-state-changed",{detail:{action:"transfer",fromDesignerId:o.designerId,toDesignerId:Number(l),queueId:o.id}}));else{const n=await e.json();u(n.error||"調整失敗")}}catch(e){console.error("API 呼叫錯誤:",e),u("調整失敗")}finally{B(!1)}},j=e=>{const n=S.find(s=>s.id===e);return n?n.name:"未知設計師"},w=e=>({1:"洗剪吹",2:"染髮",3:"燙髮"})[e]||"未知服務",Q=e=>({waiting:"等待中",called:"已叫號",done:"已完成",absent:"過號"})[e]||e,Z=e=>{const n=document.getElementById(`designer-card-${e}`);n&&n.scrollIntoView({behavior:"smooth",block:"center"})},m=async(e,n,s)=>{if(console.log(`${n} - 設計師: ${e.name}`),n==="調整客人"){X(e);return}if(n==="休假中"){try{(await fetch(`/api/designers/${e.id}/pause`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({isPaused:!0,isOnVacation:!0})})).ok&&d()}catch(r){console.error("API 呼叫錯誤:",r)}return}if(n==="恢復上線"){try{(await fetch(`/api/designers/${e.id}/pause`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({isPaused:!1,isOnVacation:!1})})).ok&&d()}catch(r){console.error("API 呼叫錯誤:",r)}return}if(n==="暫停接單"){try{(await fetch(`/api/designers/${e.id}/pause`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({isPaused:!0,isOnVacation:!1})})).ok&&d()}catch(r){console.error("API 呼叫錯誤:",r)}return}if(n==="恢復接單"){try{(await fetch(`/api/designers/${e.id}/pause`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({isPaused:!1,isOnVacation:!1})})).ok&&d()}catch(r){console.error("API 呼叫錯誤:",r)}return}if(n==="報到"){if(s&&s!=="-")try{const r=await c.post("/api/queue/checkin",{designerId:e.id,number:s});r.data.success?(console.log("報到成功:",r.data),d(),p(),window.dispatchEvent(new CustomEvent("queue-updated")),setTimeout(()=>{Z(e.id)},300)):console.error("報到失敗:",r.data)}catch(r){console.error("報到 API 失敗",r),r.response&&(console.error("錯誤狀態:",r.response.status),console.error("錯誤訊息:",r.response.data))}else console.log("沒有下一位客人可報到");return}if(n==="過號"){const r=D.find(a=>a.designerId===e.id);if(r&&r.id)try{await c.patch(`/api/queue/${r.id}/absent`),d(),p(),window.dispatchEvent(new CustomEvent("queue-updated"))}catch(a){console.error("過號 API 失敗",a)}else console.warn("找不到下一位客人或 id 為 undefined，無法過號");return}if(n==="結束"){console.log(`設計師 ${e.name} 結束當前服務`);const r=z.find(a=>a.designerId===e.id);if(r)try{const a=await c.patch(`/api/queue/${r.id}/complete`,{designerId:e.id,number:r.number});a.data.success?(console.log("服務完成成功:",a.data),d(),p(),window.dispatchEvent(new CustomEvent("queue-updated"))):console.error("服務完成失敗:",a.data)}catch(a){console.error("完成服務 API 失敗",a),g(T=>T.filter(re=>re.designerId!==e.id)),window.dispatchEvent(new CustomEvent("queue-updated"))}else console.log("該設計師沒有正在服務的客人"),g(a=>a.filter(T=>T.designerId!==e.id)),window.dispatchEvent(new CustomEvent("queue-updated"));return}},L=i.useMemo(()=>O.filter(e=>(e.status==="waiting"||e.status==="called")&&e.createdAt.slice(0,10)===M&&`${e.number}${j(e.designerId)}${w(e.serviceId)}`.includes(N)),[O,M,N,j,w]),_=[...S].sort((e,n)=>e.id-n.id),ee=async()=>{const e=await c.get("/api/products");U(e.data)},te=e=>{F(e),k(!0),ee(),G("")},ne=async e=>{const n=V.find(s=>s.id===Number(e));if(!n)return alert("產品不存在");try{await c.post("/api/transactions",{type:"income",amount:parseFloat(n.price),description:`產品銷售：${n.name}（設計師：${y.name}）`,category:"product",designerId:y.id,productId:n.id,date:new Date().toISOString().split("T")[0]}),k(!1)}catch{alert("寫入財務失敗")}};return t.jsxs("div",{className:"admin-container",children:[t.jsx("div",{className:"serving-grid serving-grid-progress",style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gridTemplateRows:"repeat(2, 1fr)",gap:"2rem",justifyItems:"center",alignItems:"stretch",width:"100%",maxWidth:"1200px",margin:"0 auto",paddingTop:0,position:"relative",zIndex:2e3},children:_.filter(e=>e.name!=="不指定").map(e=>{const n=K(e),s=e.isPaused,r=e.isOnVacation;return t.jsxs("div",{id:`designer-card-${e.id}`,className:"serving-card-progress",style:{minWidth:"0",maxWidth:"540px",width:"95%",position:"relative",display:"flex",flexDirection:"column",justifyContent:"flex-start",padding:"0",paddingBottom:"1.7cm"},children:[t.jsxs("div",{className:"designer-header",style:{display:"flex",alignItems:"center",width:"100%",padding:"1.1em 1.2em 0.5em 1.2em",boxSizing:"border-box",borderBottom:"1px solid rgba(247,171,94,0.12)"},children:[t.jsxs("span",{className:"designer-title",style:{flex:"0 0 auto",alignSelf:"center",fontSize:"0.85em",fontWeight:700,color:"#f7ab5e",textAlign:"left",marginRight:"auto"},children:["設計師 ",t.jsx("b",{style:{fontSize:"0.95em"},children:e.name})]}),t.jsxs("div",{style:{display:"flex",gap:"0.2em",flex:1,justifyContent:"flex-end",alignItems:"center"},children:[t.jsx("button",{className:"btn btn-primary",style:{color:"#333",fontWeight:600,fontSize:"0.65em",margin:0,padding:"0.1em",minWidth:0,minHeight:0},onClick:()=>m(e,"調整客人"),title:"調整客人",children:"📖"}),t.jsx("button",{className:"btn btn-primary",style:{color:"#ff9800",fontWeight:600,fontSize:"0.65em",margin:0,padding:"0.1em",minWidth:0,minHeight:0},onClick:()=>m(e,s?"恢復接單":"暫停接單"),title:s?"恢復接單":"暫停接單",children:"⏸️"}),r?t.jsx("button",{className:"btn btn-primary",style:{color:"#2196f3",fontWeight:600,fontSize:"0.65em",margin:0,padding:"0.1em",minWidth:0,minHeight:0},onClick:()=>m(e,"恢復上線"),title:"恢復上線",children:"🏖️"}):t.jsx("button",{className:"btn btn-primary",style:{color:"#2196f3",fontWeight:600,fontSize:"0.65em",margin:0,padding:"0.1em",minWidth:0,minHeight:0},onClick:()=>m(e,"休假中"),title:"休假中",children:"🏖️"}),t.jsx("button",{className:"btn btn-primary",style:{color:"#8bc34a",fontWeight:600,fontSize:"0.65em",margin:0,padding:"0.1em",minWidth:0,minHeight:0},onClick:()=>te(e),title:"產品",children:"🛍️"})]})]}),t.jsxs("div",{className:"card-main-row",style:{display:"flex",gap:"0",marginTop:"1em"},children:[t.jsxs("div",{className:"card-col card-col-now",style:{flex:1,padding:"1em",textAlign:"center",background:"transparent",minHeight:"160px"},children:[t.jsx("div",{className:"col-label",style:{fontWeight:600,marginBottom:"0.5em"},children:"目前號碼"}),t.jsx("div",{className:"col-number now-number",style:{fontSize:"2em",fontWeight:700,background:"transparent",boxShadow:"none",color:"#ff9800"},children:n.currentNumber}),t.jsx("div",{className:"col-service",style:{fontSize:"1em",color:"#ff9800",marginTop:"0.3em"},children:n.currentService}),t.jsx("button",{className:"orange-big-btn",onClick:()=>m(e,"結束"),children:"結束"})]}),t.jsxs("div",{className:"card-col card-col-next",style:{flex:1,padding:"1em",textAlign:"center",background:"transparent",minHeight:"160px"},children:[t.jsx("div",{className:"col-label",style:{fontWeight:600,marginBottom:"0.5em"},children:"下一位"}),t.jsx("div",{className:"col-number next-number",style:{fontSize:"2em",fontWeight:700,color:"#ff9800"},children:n.nextNumber}),t.jsx("div",{className:"col-service",style:{fontSize:"1em",color:"#f7ab5e",marginTop:"0.3em"},children:n.nextService}),t.jsxs("div",{style:{marginTop:"0.7em",display:"flex",gap:"0.5em",justifyContent:"center"},children:[t.jsx("button",{className:"orange-big-btn",onClick:()=>m(e,"報到",n.nextNumber),disabled:n.nextNumber==="-"||!n.nextNumber,style:{opacity:n.nextNumber==="-"||!n.nextNumber?.5:1},children:"報到"}),t.jsx("button",{className:"orange-big-btn",onClick:()=>m(e,"過號"),children:"過號"})]})]})]}),e.isOnVacation&&!C&&!I&&t.jsx("div",{className:"vacation-mask",children:t.jsx("span",{style:{fontSize:"2em",fontWeight:900,color:"#fff",letterSpacing:"4px",textShadow:"0 2px 16px #333d38cc"},children:"休假中"})}),e.isPaused&&!e.isOnVacation&&!C&&!I&&t.jsx("div",{className:"paused-mask",children:t.jsx("span",{style:{fontSize:"2em",fontWeight:900,color:"#fff",letterSpacing:"4px",textShadow:"0 2px 16px #333d38cc"},children:"暫時停止服務"})})]},e.id)})}),I&&t.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(10, 10, 10, 0.88)",zIndex:3e3,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"},children:t.jsxs("div",{style:{background:"#232a2b",borderRadius:"18px",padding:"2.5rem 2rem",maxWidth:"950px",width:"100%",maxHeight:"92vh",overflow:"auto",border:"3px solid #fff",boxShadow:"0 12px 48px 0 rgba(0,0,0,0.45)",display:"flex",flexDirection:window.innerWidth<700?"column":"row",gap:"2.5rem",transition:"all 0.2s"},children:[t.jsxs("div",{style:{flex:1,minWidth:"260px",background:"#2e3638",borderRadius:"12px",padding:"1.2rem 1rem",boxShadow:"0 2px 12px #0002",display:"flex",flexDirection:"column",height:"100%"},children:[t.jsx("h4",{style:{color:"#f7ab5e",marginBottom:"1rem"},children:"今日排隊客人"}),t.jsx("input",{type:"text",placeholder:"搜尋號碼/設計師/服務...",value:N,onChange:e=>q(e.target.value),style:{width:"100%",marginBottom:"1rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #e9ecef",background:"#222",color:"#f7ab5e"}}),t.jsx("div",{style:{maxHeight:"350px",overflow:"auto"},children:L.length===0?t.jsx("p",{style:{color:"#f7ab5e",textAlign:"center",fontStyle:"italic"},children:"目前沒有等待中的客人"}):t.jsx("div",{style:{display:"grid",gap:"0.5rem"},children:L.map(e=>t.jsxs("div",{onClick:()=>f(e),style:{display:"flex",alignItems:"center",padding:"1rem",border:`2px solid ${o?.id===e.id?"#f7ab5e":"#e9ecef"}`,borderRadius:"8px",cursor:"pointer",transition:"all 0.3s ease",background:o?.id===e.id?"#4a5a4f":"#333d38",boxShadow:o?.id===e.id?"0 0 0 2px #f7ab5e55":"none"},children:[t.jsxs("div",{style:{background:"#007bff",color:"#f7ab5e",padding:"0.5rem 1rem",borderRadius:"6px",fontWeight:"600",marginRight:"1rem",minWidth:"60px",textAlign:"center"},children:["#",e.number]}),t.jsxs("div",{style:{flex:1},children:[t.jsxs("div",{style:{color:"#f7ab5e",fontSize:"0.9rem"},children:["設計師: ",j(e.designerId)]}),t.jsxs("div",{style:{color:"#f7ab5e",fontSize:"0.9rem"},children:["服務: ",w(e.serviceId)]}),t.jsxs("div",{style:{color:"#f7ab5e",fontSize:"0.9rem"},children:["狀態: ",Q(e.status)]})]})]},e.id))})})]}),t.jsxs("div",{style:{flex:1,minWidth:"320px",background:"#232a2b",borderRadius:"12px",padding:"1.5rem 1.2rem",boxShadow:"0 2px 12px #0002",display:"flex",flexDirection:"column",justifyContent:"flex-start",borderLeft:window.innerWidth<700?"none":"2px solid #444",borderTop:window.innerWidth<700?"2px solid #444":"none",marginLeft:window.innerWidth<700?0:"1.2rem",marginTop:window.innerWidth<700?"1.2rem":0},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1.5rem"},children:[t.jsx("h3",{style:{margin:0,color:"#f7ab5e",fontSize:"1.5rem"},children:o?`調整 #${o.number}`:"請先選擇要調整的客人"}),t.jsx("button",{onClick:()=>{A(!1),E(null),f(null),x(""),h(""),u("")},style:{background:"none",border:"none",fontSize:"1.5rem",color:"#f7ab5e",cursor:"pointer",padding:"0.5rem"},children:"×"})]}),H&&t.jsx("div",{style:{padding:"1rem",borderRadius:"8px",marginBottom:"1rem",background:"#4a5a4f",color:"#f7ab5e"},children:H}),o&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{marginBottom:"1rem",padding:"1rem",background:"#333d38",borderRadius:"8px"},children:[t.jsxs("p",{style:{margin:"0",color:"#f7ab5e"},children:[t.jsx("strong",{children:"號碼:"})," #",o.number]}),t.jsxs("p",{style:{margin:"0",color:"#f7ab5e"},children:[t.jsx("strong",{children:"原設計師:"})," ",j(o.designerId)]}),t.jsxs("p",{style:{margin:"0",color:"#f7ab5e"},children:[t.jsx("strong",{children:"服務:"})," ",w(o.serviceId)]}),t.jsxs("p",{style:{margin:"0",color:"#f7ab5e"},children:[t.jsx("strong",{children:"狀態:"})," ",Q(o.status)]})]}),t.jsxs("div",{style:{marginBottom:"1rem"},children:[t.jsx("label",{style:{display:"block",marginBottom:"0.5rem",color:"#f7ab5e",fontWeight:"500"},children:"調整至設計師:"}),t.jsxs("select",{value:l,onChange:e=>x(e.target.value),style:{width:"100%",padding:"0.75rem",border:"2px solid #e9ecef",borderRadius:"6px",fontSize:"1rem",background:"#333d38",color:"#f7ab5e"},children:[t.jsx("option",{value:"",children:"請選擇設計師"}),S.filter(e=>e.id!==o.designerId&&!e.isPaused).map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]})]}),t.jsxs("div",{style:{marginBottom:"1rem"},children:[t.jsx("label",{style:{display:"block",marginBottom:"0.5rem",color:"#f7ab5e",fontWeight:"500"},children:"調整原因 (選填):"}),t.jsx("textarea",{value:$,onChange:e=>h(e.target.value),placeholder:"請輸入調整原因...",style:{width:"100%",padding:"0.75rem",border:"2px solid #e9ecef",borderRadius:"6px",fontSize:"1rem",background:"#333d38",color:"#f7ab5e",resize:"vertical",minHeight:"100px"}})]}),t.jsxs("div",{style:{display:"flex",gap:"1rem"},children:[t.jsx("button",{onClick:Y,disabled:b||!l,style:{padding:"0.75rem 1.5rem",background:b||!l?"#6c757d":"#007bff",color:"#f7ab5e",border:"none",borderRadius:"6px",cursor:b||!l?"not-allowed":"pointer",fontSize:"1rem",fontWeight:"500"},children:b?"調整中...":"確認調整"}),t.jsx("button",{onClick:()=>{f(null),x(""),h("")},style:{padding:"0.75rem 1.5rem",background:"#6c757d",color:"#f7ab5e",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"1rem",fontWeight:"500"},children:"取消"})]})]})]})]})}),C&&y&&t.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(10,10,10,0.88)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",pointerEvents:"auto"},children:t.jsxs("div",{style:{background:"#333d38",borderRadius:"28px",padding:"3.5rem 2.5rem",maxWidth:"700px",width:"100%",boxShadow:"0 16px 64px 0 rgba(0,0,0,0.55)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[t.jsxs("h3",{style:{color:"#f7ab5e",marginBottom:"2.2rem",fontSize:"2.1em",fontWeight:900,textAlign:"center",letterSpacing:"0.04em"},children:["產品銷售 - ",y.name]}),t.jsx("div",{className:"product-btn-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:"2.2em 2.2em",margin:"2.5em 0",justifyItems:"center",alignItems:"center",width:"100%"},children:V.map(e=>t.jsxs("button",{className:"product-btn",onClick:()=>W(e),title:e.name,children:[e.name,"（$",e.price,"）"]},e.id))}),t.jsx("button",{className:"btn btn-secondary",onClick:()=>k(!1),style:{marginTop:"1.5em",padding:"1em 2.5em",borderRadius:"999px",fontSize:"1.1em",background:"#f7ab5e",color:"#232a2b",fontWeight:700,border:"none",boxShadow:"0 2px 8px #0002",cursor:"pointer",letterSpacing:"0.04em"},children:"取消"})]})}),v&&(v.name?t.jsx("div",{className:"product-modal-bg",style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(10,10,10,0.88)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",pointerEvents:"auto"},children:t.jsxs("div",{className:"product-modal-content",style:{maxWidth:"400px",padding:"2.5rem 1.5rem",background:"#333d38",borderRadius:"28px",boxShadow:"0 16px 64px 0 rgba(0,0,0,0.55)",width:"100%",textAlign:"center"},children:[t.jsxs("div",{style:{color:"#f7ab5e",fontSize:"1.3em",fontWeight:700,marginBottom:"2em"},children:["確定要完成銷售「",v.name,"」嗎？"]}),t.jsxs("div",{style:{display:"flex",justifyContent:"center",gap:"2em"},children:[t.jsx("button",{className:"product-btn",style:{background:"#f7ab5e",color:"#232a2b",fontWeight:800},onClick:()=>{ne(v.id),W(null)},children:"確認"}),t.jsx("button",{className:"product-btn",style:{background:"#444",color:"#f7ab5e",fontWeight:800},onClick:()=>W(null),children:"取消"})]})]})}):t.jsx("div",{className:"product-modal-bg",style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(10,10,10,0.88)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",pointerEvents:"auto"},children:t.jsx("div",{className:"product-modal-content",style:{maxWidth:"400px",padding:"2.5rem 1.5rem",color:"red",textAlign:"center",background:"#fff",borderRadius:"28px"},children:"彈窗資料異常"})})),t.jsx("style",{children:`
@media (min-width: 600px) and (max-width: 900px) {
  .product-btn-grid {
    grid-template-columns: repeat(4, 1fr) !important;
  }
}
`})]})}export{ae as default};
