import{r as a,u as ye,a as m,j as e}from"./index-CMs8uBbc.js";import{u as Se,a as pe}from"./useAvailableDesigners-BnvwQ17M.js";function $e(){const[f,h]=a.useState(null),[r,T]=a.useState(()=>{const s=localStorage.getItem("token");return s?JSON.parse(atob(s.split(".")[1])):null}),[d,_]=a.useState([]),[y,ee]=a.useState([]),[b,se]=a.useState(null),[i,R]=a.useState(""),[c,D]=a.useState(""),[Ne,u]=a.useState(""),[B,H]=a.useState(!1),[S,Q]=a.useState(null),[ne,$]=a.useState(!1),[te,q]=a.useState(!1),[ae,O]=a.useState(10),[p,ie]=a.useState([]),[ke,le]=a.useState(new Date),[N,re]=a.useState(null),[we,ce]=a.useState(!1),[oe,k]=a.useState(!1),[P,U]=a.useState([]),[g,w]=a.useState(!1),[Z,v]=a.useState(""),[J,C]=a.useState(null),[V,A]=a.useState(null),I=ye();a.useEffect(()=>{document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",F(),de(),ue(),x();const s=setInterval(()=>{x()},6e4),n=()=>{console.log("Queue: 收到設計師狀態變更事件，重新載入設計師資料"),F(),x()};return window.addEventListener("designer-state-changed",n),()=>{clearInterval(s),window.removeEventListener("designer-state-changed",n),document.body.style.overflow="",document.documentElement.style.overflow=""}},[]),a.useEffect(()=>{p.forEach(s=>{s.serviceId||console.warn("currentServing 缺少 serviceId:",s)})},[p]),a.useEffect(()=>{r&&h(!0)},[r]);const F=async()=>{try{const s=await m.get("/api/designers");_(s.data)}catch(s){console.error("載入設計師失敗:",s)}},de=async()=>{try{const s=await m.get("/api/services");ee(s.data)}catch(s){console.error("載入服務失敗:",s)}},ue=async()=>{try{const s=await m.get("/api/worktime");se(s.data)}catch(s){console.error("載入工作時間失敗:",s)}},x=async()=>{try{const s=await m.get("/api/queue/today-stats");ie(s.data.currentServing||[]),re(s.data.designerStats||null),le(new Date)}catch(s){console.error("載入當前服務狀態失敗:",s)}},G=()=>{if(!b)return!0;const s=new Date,n=s.getDay();if(!b.openDays?.[n])return{valid:!1,reason:"今日非營業日"};const t=b.openTimes?.[n];if(t?.start&&t?.end){const l=s.toTimeString().slice(0,5);if(l<t.start||l>=t.end)return{valid:!1,reason:`營業時間為 ${t.start} - ${t.end}`}}return{valid:!0}},M=Se(d),me=pe(y,d,i),fe=()=>{h(!0),r?(h(!0),I("/queue")):I("/login?redirect=queue")},he=async()=>{if(f===null){u("請選擇訪客或會員");return}if(f&&!r){u("請先登入會員");return}if(i===""){u("請選擇設計師");return}if(!c){u("請選擇服務項目");return}if(console.log("送出 queue:",{designerId:i,serviceId:c,userId:r?.id}),!G().valid){u("非常抱歉!  今日非營業日無法提供抽號服務 !!"),ce(!0);return}H(!0),u("");try{let n=null;f&&r&&(n=r.id);const t=await m.post("/api/queue",{designerId:i,serviceId:c,type:"onsite",userId:n});Q(t.data.data),x(),O(10);const l=setInterval(()=>{O(o=>o<=1?(clearInterval(l),Q(null),R(""),D(""),h(null),localStorage.removeItem("token"),T(null),I("/queue"),window.location.reload(),10):o-1)},1e3);f&&r&&window.dispatchEvent(new Event("queue-updated"))}catch(n){u(n.response?.data?.error||"排隊失敗")}finally{H(!1)}},K=s=>{R(Number(s)),D(""),$(!1)},be=s=>{D(Number(s)),q(!1)},X=()=>{if(i===0)return"不指定";const s=d.find(n=>n.id===Number(i));return s?s.name:""},Y=()=>{const s=y.find(n=>n.id===c);return s?`${s.name} - $${s.price}`:""},ge=(()=>{if(!b)return null;const s=G();if(!s.valid)return e.jsx("div",{className:"business-status-message",style:{fontSize:"1rem",padding:"0.3em 1em"},children:e.jsxs("p",{children:["⚠️ ",s.reason]})});const t=new Date().getDay(),l=b.openTimes?.[t];return l?.start&&l?.end?e.jsx("div",{className:"business-status-message",style:{fontSize:"1rem",padding:"0.3em 1em"},children:e.jsxs("p",{children:["✅ 營業中 - 今日營業時間：",l.start," - ",l.end]})}):null})(),ve=async()=>{v(""),w(!0),k(!0);try{const s=new Date().toLocaleDateString("en-CA",{timeZone:"Asia/Taipei"}),n=await m.get("/api/queue");U(n.data.filter(t=>{if(t.status!=="absent")return!1;const l=new Date(t.createdAt).toLocaleDateString("en-CA",{timeZone:"Asia/Taipei"}),o=t.absentAt?new Date(t.absentAt).toLocaleDateString("en-CA",{timeZone:"Asia/Taipei"}):null;return l===s||o===s}))}catch{v("取得過號名單失敗")}finally{w(!1)}},xe=async s=>{w(!0),v("");try{await m.post(`/api/queue/${s}/checkin`),k(!1),U([]),C(null),A(null),v(""),x()}catch(n){v(n.response?.data?.error||"報到失敗")}finally{w(!1)}},E={};return p.forEach(s=>{const n=d.find(t=>t.id===s.designerId);n&&!E[n.name]&&(E[n.name]={serving:s,designer:n})}),Object.values(E),S?e.jsxs("div",{className:"queue-container",children:[e.jsxs("div",{className:"queue-header",children:[e.jsx("h2",{style:{fontSize:"0.8em"},children:"現場排隊"}),e.jsx("p",{children:"抽號成功！"})]}),e.jsxs("div",{className:"queue-step",style:{textAlign:"center"},children:[e.jsx("h3",{children:"抽號成功！"}),e.jsxs("p",{style:{fontSize:"1.5em",fontWeight:"bold"},children:["您的號碼是：",e.jsx("span",{style:{fontWeight:"bold",fontSize:"2em",color:"#ff9800"},children:S.number})]}),e.jsxs("p",{children:["設計師：",X()||S.designerName||"—"]}),e.jsxs("p",{children:["服務項目：",Y()||S.serviceName||"—"]}),e.jsx("p",{style:{fontSize:"1.2em"},children:"請留意叫號，謝謝！"}),e.jsxs("p",{style:{fontSize:"1.2em",marginTop:"1em"},children:[ae," 秒後自動返回現場排隊並且登出會員"]}),e.jsx("button",{className:"btn btn-primary",onClick:()=>{localStorage.removeItem("token"),T(null),I("/queue"),window.location.reload()},children:"返回現場排隊並且登出會員"})]})]}):e.jsxs("div",{className:"queue-page",children:[e.jsxs("header",{className:"queue-header queue-header-flex",children:[e.jsx("h1",{style:{fontSize:"0.8em"},children:"現場排隊"}),e.jsx("div",{className:"absent-checkin-btn",children:e.jsx("button",{onClick:ve,children:"過號報到"})})]}),oe&&e.jsx("div",{className:"modal-overlay",onClick:()=>k(!1),children:e.jsxs("div",{className:"modal-content absent-modal confirm-bg-all",style:{maxWidth:"700px",background:"#333d38",color:"#fff"},children:[e.jsx("div",{className:"absent-modal-header",style:{background:"#333d38",color:"#fff"},children:e.jsx("h3",{style:{color:"#fff",textAlign:"center",fontSize:"2em",width:"100%",margin:0},children:"過號報到"})}),e.jsxs("div",{className:"absent-modal-body",style:{background:"#333d38",color:"#fff"},children:[g?e.jsx("div",{className:"absent-loading",children:"載入中..."}):P.length===0?e.jsx("div",{className:"absent-empty",children:"今日沒有過號可報到"}):e.jsx("div",{className:"absent-list",children:P.map((s,n)=>e.jsxs("button",{className:"absent-list-item",onClick:()=>{C(s.id),A({number:s.number,designer:d.find(t=>t.id===s.designerId)?.name||"未知"})},disabled:g,style:{background:"#ffe082",color:"#333d38",fontWeight:"bold"},children:[e.jsxs("div",{className:"absent-number",style:{color:"#333d38"},children:[s.number," 號"]}),e.jsxs("div",{className:"absent-designer",style:{color:"#333d38"},children:["設計師：",d.find(t=>t.id===s.designerId)?.name||"未知"]})]},`absent-${s.id}-${n}`))}),Z&&e.jsx("div",{className:"absent-msg",style:{color:"#ff5252"},children:Z})]}),e.jsx("div",{className:"absent-modal-footer",style:{background:"#333d38",color:"#fff",display:"flex",justifyContent:"center"},children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>k(!1),disabled:g,style:{background:"#fff",color:"#333d38",borderRadius:"8px",fontWeight:"bold",minWidth:"120px"},children:"關閉"})})]})}),J&&e.jsx("div",{className:"modal-overlay",onClick:()=>{C(null),A(null)},children:e.jsxs("div",{className:"modal-content absent-modal confirm-bg-all",style:{maxWidth:"340px",background:"#333d38",color:"#fff"},children:[e.jsx("div",{className:"absent-modal-header confirm-bg",style:{background:"#333d38",color:"#fff",justifyContent:"center",textAlign:"center"},children:e.jsx("h3",{style:{width:"100%",textAlign:"center",margin:"0 auto",color:"#fff"},children:"過號報到"})}),e.jsxs("div",{className:"absent-modal-body",style:{background:"#333d38",color:"#fff",textAlign:"center"},children:[e.jsxs("div",{style:{fontSize:"1.2em",margin:"1.5em 0",color:"#fff"},children:["號碼：",e.jsx("span",{style:{color:"#fff",fontWeight:"bold",fontSize:"2.2em"},children:V?.number}),e.jsx("br",{}),"設計師：",e.jsx("span",{style:{color:"#fff"},children:V?.designer})]}),e.jsx("div",{className:"absent-msg",style:{color:"#ff5252",fontSize:"1.4em"},children:"此操作無法復原，請確定是否完成該號碼過號報到!!!"})]}),e.jsxs("div",{className:"absent-modal-footer",style:{background:"#333d38",color:"#fff"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{C(null),A(null)},disabled:g,children:"取消"}),e.jsx("button",{className:"btn btn-primary",style:{background:"#fff",color:"#333d38",borderRadius:"8px",fontWeight:"bold"},onClick:()=>xe(J),disabled:g,children:"確定"})]})]})}),e.jsxs("div",{className:"queue-content",children:[e.jsxs("section",{className:"queue-status-panel",children:[ge,e.jsxs("div",{className:"kanban-board",children:[e.jsx("h3",{style:{margin:"0 0 0.5em 0",fontWeight:"bold",fontSize:"1.1em"},children:"即時看板"}),e.jsx("div",{className:"kanban-list",children:d.map((s,n)=>{if(s.isOnVacation)return null;const t=p.find(j=>j.designerId===s.id),l=t?y.find(j=>String(j.id)===String(t.serviceId)):null;let o=null;if(N&&s){const j=N[s.id]?.waiting||0,W=(s.services||[]).map(z=>y.find(L=>L.id===z)?.duration||60),je=W.length?W.reduce((z,L)=>z+L,0)/W.length:60;o=(j+1)*je}return e.jsxs("div",{className:"kanban-card",children:[e.jsx("div",{className:"kanban-designer",children:s.name}),e.jsx("div",{className:"kanban-number",children:t?`${t.number} 號`:"暫無"}),e.jsx("div",{className:"kanban-service",children:t&&l?l.name:"—"}),e.jsxs("div",{className:"kanban-wait",children:["預估等待：",s.isPaused?"暫停服務":t||N&&N[s.id]?.waiting>0?t&&o!==null?`${Math.round(o)} 分鐘`:"—":"立刻"]})]},`kanban-${s.id}`)})})]})]}),e.jsxs("section",{className:"queue-form-panel",children:[e.jsxs("div",{className:"queue-step",children:[e.jsx("h3",{children:"步驟 1：選擇身份"}),e.jsxs("div",{className:"member-selection",children:[e.jsx("button",{className:`btn${f===!1?" btn-primary selected":" btn-secondary"}`,onClick:()=>h(!1),children:"訪客"}),e.jsx("button",{className:`btn${f===!0?" btn-primary selected":" btn-secondary"}`,onClick:fe,children:"會員"})]})]}),e.jsxs("div",{className:"queue-step",children:[e.jsx("h3",{children:"步驟 2：選擇設計師"}),e.jsxs("div",{className:"designer-selection",children:[e.jsx("button",{className:`btn queue-main-btn btn-secondary${i!==""?" selected":""}`,onClick:()=>$(!0),children:i!==""?X():"請選擇設計師"}),M.length===0&&e.jsx("p",{className:"no-available-designers",children:"⚠️ 目前沒有可用的設計師（可能為非營業日或所有設計師暫停接單）"})]})]}),e.jsxs("div",{className:"queue-step",children:[e.jsx("h3",{children:"步驟 3：選擇服務項目"}),e.jsxs("div",{className:"service-selection",children:[e.jsx("button",{className:`btn queue-main-btn btn-secondary${c?" selected":""}`,onClick:()=>q(!0),disabled:i==="",children:c?Y():i!==""?"請選擇服務項目":"請先選擇設計師"}),i===""&&e.jsx("p",{className:"service-hint",children:"⚠️ 請先選擇設計師，才能選擇對應的服務項目"})]})]}),e.jsx("div",{className:"queue-step",children:e.jsx("button",{className:"btn queue-main-btn btn-primary",onClick:he,disabled:B||i===""||!c||M.length===0,children:B?"處理中...":"抽號"})})]})]}),ne&&e.jsx("div",{className:"modal-overlay",onClick:()=>$(!1),children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{children:"選擇設計師"}),e.jsxs("div",{className:"designer-grid",children:[e.jsx("button",{className:`designer-item${i===0?" selected":""}`,onClick:()=>K(0),children:"不指定"},"designer-0"),M.map((s,n)=>e.jsx("button",{className:`designer-item${i===s.id?" selected":""}`,onClick:()=>K(s.id),children:s.name},`designer-${s.id}`))]})]})}),te&&e.jsx("div",{className:"modal-overlay",onClick:()=>q(!1),children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{children:"選擇服務項目"}),e.jsx("div",{className:"service-grid",children:me.map((s,n)=>e.jsx("button",{className:`service-item${c===s.id?" selected":""}`,onClick:()=>be(s.id),children:s.name},`service-${s.id}`))})]})})]})}export{$e as default};
