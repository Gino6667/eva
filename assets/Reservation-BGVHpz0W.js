import{r as n,u as ae,a as d,j as e}from"./index-CMs8uBbc.js";import{u as le,a as oe}from"./useAvailableDesigners-BnvwQ17M.js";function fe(){const[a,ce]=n.useState(()=>{const s=localStorage.getItem("token");return s?JSON.parse(atob(s.split(".")[1])):null}),[u,R]=n.useState([]),[o,T]=n.useState([]),[m,Q]=n.useState(null),[r,U]=n.useState(""),[l,C]=n.useState(""),[b,c]=n.useState(""),[q,$]=n.useState(!1),[g,P]=n.useState(null),[O,p]=n.useState(!1),[J,S]=n.useState(!1),[V,F]=n.useState([]),[v,G]=n.useState(null),[de,H]=n.useState(new Date),[ue,me]=n.useState(!0),[K,f]=n.useState(!1),X=ae(),[I,z]=n.useState([]),y=new Date().toISOString().slice(0,10),B=a?I.filter(s=>s.createdAt.slice(0,10)===y&&s.status!=="done"):[];n.useEffect(()=>{M(),Y(),Z(),_();const s=()=>{console.log("Reservation: 收到設計師狀態變更事件，重新載入設計師資料"),M()};return window.addEventListener("designer-state-changed",s),()=>{window.removeEventListener("designer-state-changed",s)}},[]),n.useEffect(()=>{if(!a)return;const s=async()=>{try{const i=await d.get(`/api/queue/user/${a.id}?date=${y}`);z(i.data)}catch{z([])}};s();const t=()=>{s()};return window.addEventListener("queue-updated",t),()=>{window.removeEventListener("queue-updated",t)}},[a,y]);const M=async()=>{try{const s=await d.get("/api/designers");R(s.data)}catch(s){console.error("載入設計師失敗:",s)}},Y=async()=>{try{const s=await d.get("/api/services");T(s.data)}catch(s){console.error("載入服務失敗:",s)}},Z=async()=>{try{const s=await d.get("/api/worktime");Q(s.data)}catch(s){console.error("載入工作時間失敗:",s)}},_=async()=>{try{const s=await d.get("/api/queue/today-stats");F(s.data.currentServing||[]),G(s.data.designerStats||null),H(new Date)}catch(s){console.error("載入當前服務狀態失敗:",s)}},ee=()=>{if(!m)return!0;const t=new Date().getDay();return m.openDays?.[t]||!1},x=le(u),j=oe(o,u,r),se=async()=>{if(!a){c("請先登入會員");return}if(r===""){c("請選擇設計師");return}if(!l){c("請選擇服務項目");return}if(console.log({designerId:r,serviceId:l,userId:a?.id}),!ee()){c("非常抱歉!  今日非營業日無法提供抽號服務 !!"),f(!0);return}$(!0),c("");try{const s=await d.post("/api/queue",{designerId:Number(r),serviceId:Number(l),userId:a.id,type:"online"});P(s.data.data)}catch(s){c(s.response?.data?.error||"抽號失敗"),f(!0)}finally{$(!1)}},te=()=>{X("/login?redirect=reservation")},W=s=>{U(Number(s)),p(!1)},ne=s=>{C(Number(s)),S(!1)},E=()=>{if(r===0)return"不指定";const s=u.find(t=>t.id===Number(r));return s?s.name:""},A=()=>{const s=o.find(t=>String(t.id)===String(l));return s?`${s.name} - $${s.price}`:""},re=()=>{const s=new Date,t=["週日","週一","週二","週三","週四","週五","週六"];return`${s.getMonth()+1}/${s.getDate()} (${t[s.getDay()]})`},L=()=>{if(!m)return null;const t=new Date().getDay();if(!m.openDays?.[t])return e.jsx("div",{className:"business-status-message",children:e.jsx("p",{children:"⚠️ 今日非營業日"})});const i=m.openTimes?.[t];return i?.start&&i?.end?e.jsx("div",{className:"business-status-message",children:e.jsxs("p",{children:["✅ 營業中 - 今日營業時間：",i.start," - ",i.end]})}):null};return L(),n.useEffect(()=>{l&&!j.some(s=>String(s.id)===String(l))&&C("")},[r,o]),g?e.jsxs("div",{id:"reservation",className:"reservation-container",children:[e.jsxs("div",{className:"reservation-header",children:[e.jsx("h2",{style:{fontSize:"1.5rem",margin:"0 0 0.5em 0",fontWeight:700},children:"線上抽號"}),e.jsx("p",{children:"抽號成功！"})]}),e.jsxs("div",{className:"reservation-step",children:[e.jsx("h3",{children:"抽號成功！"}),e.jsxs("div",{style:{textAlign:"center",padding:"2em 0"},children:[e.jsx("h2",{style:{fontWeight:900,color:"#f7ab5e",marginBottom:"1em"},children:"您已成功抽到號碼"}),e.jsxs("div",{style:{fontSize:"2.2em",fontWeight:900,color:"#ff9800",marginBottom:"0.7em"},children:["號碼：",g.number]}),e.jsxs("div",{style:{fontSize:"1.2em",color:"#fff",marginBottom:"0.5em"},children:["設計師：",E()||g.designerName||"—"]}),e.jsxs("div",{style:{fontSize:"1.2em",color:"#fff",marginBottom:"0.5em"},children:["服務項目：",A()||g.serviceName||"—"]}),e.jsxs("div",{style:{fontSize:"1.1em",color:"#fff",marginBottom:"0.5em"},children:["抽號日期：",re()]}),e.jsx("p",{style:{fontSize:"1.1em",color:"#f7ab5e",margin:"1.2em 0 1.5em 0"},children:"請留意叫號，或返回查看「即時看板」。"}),e.jsx("div",{style:{marginTop:"1rem",display:"flex",gap:"1rem",justifyContent:"center",width:"100%"},children:e.jsx("button",{className:"btn btn-secondary",onClick:()=>window.location.reload(),style:{textAlign:"center",width:"fit-content",marginLeft:"auto",marginRight:"auto",display:"block"},children:"返回"})})]})]})]}):e.jsxs("div",{id:"reservation",className:"reservation-container",children:[e.jsx("div",{className:"reservation-header",children:e.jsx("h2",{style:{fontSize:"1.5rem",margin:"0 0 0.5em 0",fontWeight:700},children:"線上抽號(僅限當日抽號)"})}),a&&B.length>0&&e.jsxs("div",{className:"user-queue-list new-user-queue-list",style:{marginBottom:"1em"},children:[e.jsx("div",{className:"user-queue-title",children:"您今日抽到的號碼："}),e.jsx("div",{className:"user-queue-btns",style:{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:"0.2em",justifyItems:"center"},children:B.map(s=>e.jsx("button",{className:"user-queue-btn new-user-queue-btn",style:{borderRadius:"50%",width:"2.5em",height:"2.5em",fontSize:"1.1em",border:"2px solid #f7ab5e",background:"#fff",color:"#f7ab5e",fontWeight:700,overflow:"hidden"},disabled:!0,children:e.jsx("span",{className:"user-queue-number",children:s.number})},s.id))})]}),a&&I.length===0&&e.jsxs("div",{style:{marginBottom:"1em",padding:"1rem",background:"rgba(33, 150, 243, 0.07)",borderRadius:"12px",border:"2px solid #ffc107",textAlign:"center"},children:[e.jsx("div",{style:{color:"#f7ab5e",fontWeight:500},children:"您今日還沒有抽號"}),e.jsx("div",{style:{color:"#f7ab5e",fontSize:"0.9rem",marginTop:"0.5rem"},children:"請前往現場排隊或線上預約抽號"})]}),e.jsxs("div",{className:"kanban-board",children:[L(),e.jsx("h3",{style:{margin:"0.2em 0 0.5em 0",fontWeight:"bold",fontSize:"1.1em"},children:"即時看板"}),e.jsx("div",{className:"kanban-list",children:u.map((s,t)=>{if(s.isOnVacation)return null;const i=V.find(h=>h.designerId===s.id);i&&o.find(h=>String(h.id)===String(i.serviceId));let N=null;if(v&&s){const h=v[s.id]?.waiting||0,w=(s.services||[]).map(k=>o.find(D=>D.id===k)?.duration||60),ie=w.length?w.reduce((k,D)=>k+D,0)/w.length:60;N=(h+1)*ie}return e.jsxs("div",{className:"kanban-card",children:[e.jsx("div",{className:"kanban-designer",children:s.name}),e.jsx("div",{className:"kanban-number",children:i?`${i.number} 號`:"暫無"}),e.jsxs("div",{className:"kanban-wait",children:["預估等待：",s.isPaused?"暫停服務":i||v&&v[s.id]?.waiting>0?i&&N!==null?`${Math.round(N)} 分鐘`:"—":"立刻"]})]},`kanban-${s.id}`)})})]}),e.jsxs("div",{className:"queue-col queue-col-right",children:[e.jsxs("div",{className:"queue-step",children:[e.jsx("h3",{children:"步驟 1：會員登入"}),e.jsx("div",{className:"member-selection",children:a?e.jsx("button",{className:"btn btn-primary member-logged-in",disabled:!0,children:"已登入會員"}):e.jsx("button",{className:"btn btn-primary",onClick:te,children:"註冊/登入會員"})})]}),e.jsxs("div",{className:"queue-step",children:[e.jsx("h3",{children:"步驟 2：選擇設計師"}),e.jsxs("div",{className:"designer-selection",children:[e.jsx("button",{className:`btn btn-secondary${r!==""?" selected":""}`,onClick:()=>p(!0),children:r!==""?E():"請選擇設計師"}),x.length===0&&e.jsx("p",{className:"no-available-designers",children:"⚠️ 目前沒有可用的設計師（可能為非營業日或所有設計師暫停接單）"})]})]}),e.jsxs("div",{className:"queue-step",children:[e.jsx("h3",{children:"步驟 3：選擇服務項目"}),e.jsxs("div",{className:"service-selection",children:[e.jsx("button",{className:`btn btn-secondary${l?" selected":""}`,onClick:()=>S(!0),disabled:r==="",children:l?A():r!==""?"請選擇服務項目":"請先選擇設計師"}),r===""&&e.jsx("p",{className:"service-hint",children:"⚠️ 請先選擇設計師，才能選擇對應的服務項目"})]})]}),e.jsx("div",{className:"queue-step",children:e.jsx("button",{className:"btn btn-primary",onClick:se,disabled:q||r===""||!l||x.length===0,children:q?"處理中...":"確認抽號"})})]}),O&&e.jsx("div",{className:"modal-overlay",onClick:()=>p(!1),children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{children:"選擇設計師"}),e.jsxs("div",{className:"designer-grid",children:[e.jsx("button",{className:`designer-item${r===0?" selected":""}`,onClick:()=>W(0),children:"不指定"},0),x.map(s=>e.jsx("button",{className:`designer-item${r===s.id?" selected":""}`,onClick:()=>W(s.id),children:s.name},s.id))]}),x.length===0&&e.jsx("p",{children:"目前沒有可用的設計師"})]})}),J&&(()=>{const s=u.find(t=>t.id===Number(r));return console.log("designer.services:",s?.services),console.log("services:",o),console.log("getAvailableServices:",j),e.jsx("div",{className:"modal-overlay",onClick:()=>S(!1),children:e.jsxs("div",{className:"modal-content service-modal",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:"選擇服務項目"}),e.jsx("div",{className:"service-grid",children:j.map(t=>e.jsxs("button",{className:`service-item${l===String(t.id)?" selected":""}`,onClick:()=>ne(t.id),children:[e.jsx("div",{children:t.name}),e.jsxs("div",{children:["$",t.price]})]},t.id))}),j.length===0&&e.jsx("p",{children:"此設計師暫無可選服務"})]})})})(),K&&e.jsx("div",{className:"modal-overlay",onClick:()=>f(!1),children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),style:{maxWidth:"350px",textAlign:"center"},children:[e.jsx("h3",{style:{marginBottom:"1em"},children:"抽號失敗"}),e.jsx("div",{style:{textAlign:"center",marginBottom:"0.5em"},children:e.jsx("span",{style:{fontSize:"2.5em",color:"#d32f2f"},children:"❌"})}),b&&b!=="抽號失敗"&&e.jsx("div",{style:{marginBottom:"1em",fontSize:"1.3em",color:"#d32f2f",fontWeight:"bold"},children:b}),e.jsx("button",{className:"btn btn-primary",onClick:()=>f(!1),children:"關閉"})]})})]})}export{fe as default};
